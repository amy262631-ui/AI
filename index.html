<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å‰µæ–°æ¢éšªæ—¥èªŒ - é›²ç«¯åŒæ­¥æ——è‰¦ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .adventure-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border-radius: 2.5rem; }
        .star-rating-active { color: #fbbf24; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .admin-only { display: none; }
        .pulse-soft { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .loading-overlay { background: rgba(255,255,255,0.8); display: none; }
        
        /* é‡å°æ¦œå–®è¡¨æ ¼çš„å­—é«”åŠ å¼· */
        .summary-table th { font-size: 1.1rem; letter-spacing: 0.1em; }
        .summary-table td { font-size: 1.5rem; vertical-align: middle; }
    </style>
</head>
<body class="min-h-screen py-10 px-4">

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 z-[100] flex items-center justify-center loading-overlay backdrop-blur-sm">
        <div class="text-center">
            <div class="relative inline-block">
                <i class="fas fa-rocket text-6xl text-indigo-600 mb-4 animate-bounce"></i>
            </div>
            <p class="text-indigo-600 font-black text-2xl tracking-widest">æ­£åœ¨ç©¿è¶Šé›²ç«¯åŒæ­¥è³‡æ–™...</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-16">
            <div class="inline-block px-8 py-2 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-full text-sm font-black mb-6 tracking-[0.3em] shadow-lg pulse-soft uppercase">
                AI Discovery Adventure ğŸŒŸ
            </div>
            <h1 class="text-6xl font-black text-slate-800 mb-6 tracking-tight">ğŸš€ AI å‰µæ–°æ¢éšªæ—¥èªŒ</h1>
            <p class="text-slate-600 text-2xl font-medium max-w-3xl mx-auto leading-relaxed">
                é€™è£¡æ˜¯æˆ‘å€‘çš„ã€Œå‰µæ„å­µåŒ–å™¨ã€ï¼è®“æˆ‘å€‘ä¸€èµ·ç©è½‰ AIï¼Œå„ªåŒ–æµç¨‹ã€‚
                <span class="block text-indigo-600 mt-4 font-black text-3xl">âœ¨ è®“å·¥ä½œæ›´è¼•é¬†ï¼Œæˆå°±æ„Ÿæ»¿æ»¿ï¼Œè®“æœªä¾†è¶…ä¹æƒ³åƒï¼ âœ¨</span>
            </p>
        </header>

        <!-- Incentive Message Section -->
        <div class="bg-indigo-600 rounded-[3rem] p-10 mb-16 shadow-2xl relative overflow-hidden text-white border-4 border-white/20">
            <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-8">
                <div class="text-center md:text-left">
                    <h3 class="text-4xl font-black mb-4 flex items-center justify-center md:justify-start">
                        <i class="fas fa-gift mr-4 text-yellow-400"></i> å†’éšªè€…çš„æˆé•·è£œçµ¦
                    </h3>
                    <p class="opacity-95 font-bold text-2xl leading-relaxed">æ‰€æœ‰çš„é€²æ­¥èˆ‡å‰µæ„ï¼Œéƒ½æ˜¯éƒ¨é–€æˆé•·çš„å‹•åŠ›ã€‚<br>æˆ‘å€‘å°‡åƒè€ƒé€™äº›æ—¥èªŒï¼Œä½œç‚ºæœªä¾†çé‡‘ç™¼æ”¾èˆ‡è·ä½èª¿å‡çš„é‡è¦é‡Œç¨‹ç¢‘ï¼</p>
                </div>
                <div class="flex-shrink-0 bg-white/10 p-6 rounded-3xl border border-white/20 text-center">
                    <p class="text-sm uppercase tracking-widest opacity-70 mb-2">Current Mission</p>
                    <p class="text-3xl font-black italic">Efficiency Boost!</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-12">
            <!-- Sidebar: Registration Form -->
            <div class="lg:col-span-1">
                <div class="adventure-card p-10 shadow-2xl border border-white/50 sticky top-10">
                    <h2 class="text-3xl font-black mb-8 text-indigo-600 flex items-center">
                        <i class="fas fa-magic mr-3"></i> å•Ÿå‹•é»å­
                    </h2>
                    <form id="aiForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest">å†’éšªè€…å§“å</label>
                            <input type="text" id="name" required placeholder="æ‚¨çš„å‹‡è€…ç¨±è™Ÿ" class="w-full px-6 py-5 bg-white border-2 border-slate-100 focus:border-indigo-400 rounded-3xl outline-none transition font-bold shadow-inner text-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest">æ¢éšªä¸»é¡Œ</label>
                            <input type="text" id="topic" required placeholder="æƒ³å„ªåŒ–çš„å…§å®¹" class="w-full px-6 py-5 bg-white border-2 border-slate-100 focus:border-indigo-400 rounded-3xl outline-none transition font-bold shadow-inner text-xl">
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest">èµ·å§‹æ—¥</label>
                                <input type="date" id="startDate" required class="w-full px-6 py-4 bg-white border-2 border-slate-100 focus:border-indigo-400 rounded-3xl outline-none transition text-lg font-bold">
                            </div>
                            <div>
                                <label class="block text-sm font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest">é è¨ˆæŠµé”æ—¥</label>
                                <input type="date" id="deadline" required class="w-full px-6 py-4 bg-white border-2 border-slate-100 focus:border-indigo-400 rounded-3xl outline-none transition text-lg font-bold">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-br from-indigo-600 to-purple-700 hover:from-indigo-500 hover:to-purple-600 text-white font-black py-6 rounded-[2rem] shadow-xl transition transform active:scale-95 mt-6 tracking-widest text-2xl">
                            ç™»éŒ„æ¢éšª ğŸš€
                        </button>
                    </form>
                    <div class="mt-10 pt-8 border-t border-slate-200">
                        <button onclick="toggleAdminView()" id="adminBtn" class="w-full py-3 text-sm font-black text-slate-400 hover:text-indigo-600 tracking-[0.2em] transition border-2 border-dashed border-slate-200 rounded-2xl uppercase">
                            <i class="fas fa-shield-alt mr-2"></i> ç®¡ç†æ¨¡å¼
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Display Area -->
            <div class="lg:col-span-3 space-y-20">
                <!-- Kanban Section -->
                <div>
                    <div class="flex justify-between items-end mb-10 px-4">
                        <h2 class="text-5xl font-black text-slate-800 tracking-tight flex items-center">
                            <i class="fas fa-map-marked-alt mr-6 text-indigo-500"></i> æ¢éšªé€²åº¦çœ‹æ¿
                        </h2>
                        <div class="text-lg font-black text-slate-400 bg-white px-6 py-3 rounded-full shadow-md border border-slate-100 uppercase tracking-widest">
                            Missions: <span id="projectCount" class="text-indigo-600">0</span>
                        </div>
                    </div>
                    <div id="projectList" class="space-y-10">
                        <!-- é è¨­è¨Šæ¯ -->
                        <div id="statusMessage" class="text-center py-20 text-slate-400 italic text-2xl bg-white/50 rounded-[3rem] border-2 border-dashed">
                            æ­£åœ¨å•Ÿå‹•é›²ç«¯é€£ç·šæ¨¡çµ„...
                        </div>
                    </div>
                </div>

                <!-- Leaderboard Section -->
                <div class="pt-10">
                    <h2 class="text-5xl font-black text-slate-800 mb-10 flex items-center tracking-tight px-4">
                        <i class="fas fa-medal mr-6 text-yellow-500"></i> å¤¥ä¼´æ¢éšªæˆ°åŠ›æ¦œ
                    </h2>
                    <div class="adventure-card shadow-2xl border-4 border-white overflow-hidden">
                        <div class="overflow-x-auto no-scrollbar">
                            <table class="w-full text-left border-collapse summary-table">
                                <thead class="bg-indigo-600 text-white uppercase font-black">
                                    <tr>
                                        <th class="px-10 py-8">å†’éšªè‹±é›„</th>
                                        <th class="px-6 py-8 text-center">æ¢éšªæ¬¡æ•¸</th>
                                        <th class="px-6 py-8 text-center">å¥§æ´ç¸½æ•¸</th>
                                        <th class="px-6 py-8 text-center">å¹³å‡é‚è¼¯</th>
                                        <th class="px-6 py-8 text-center">å¹³å‡å¯¦ç”¨</th>
                                        <th class="px-6 py-8 text-center text-yellow-300">å¹³å‡å‰µæ–°</th>
                                        <th class="px-10 py-8 text-right">æˆå°±ç¸½åˆ†</th>
                                    </tr>
                                </thead>
                                <tbody id="summaryTableBody" class="font-bold text-slate-700">
                                    <!-- æ¦œå–®è³‡æ–™ç”± JS ç”¢ç”Ÿ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <p class="text-center text-slate-500 text-lg mt-8 font-bold italic">
                        <i class="fas fa-info-circle mr-2"></i> æ­¤æ’è¡Œæ¦œæ ¹æ“šæ‰€æœ‰å·²å®Œæˆå°ˆæ¡ˆä¹‹ã€Œå¥§æ´è©•åƒ¹ã€å¯¦æ™‚åŠ æ¬Šè¨ˆç®—
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="ratingModal" class="fixed inset-0 bg-slate-900/70 hidden flex items-center justify-center z-50 p-6 backdrop-blur-md">
        <div class="bg-white rounded-[4rem] p-12 max-w-lg w-full shadow-2xl border-8 border-white">
            <div class="text-center w-full mb-10">
                <div class="text-7xl mb-6">ğŸ’–</div>
                <h3 class="text-4xl font-black text-slate-800 mb-4">å‚³é€å¥§æ´èƒ½é‡</h3>
                <p id="ratingProjectName" class="text-indigo-600 font-black text-2xl"></p>
            </div>
            <div class="space-y-8">
                <input type="text" id="voterName" placeholder="æ‚¨çš„è‹±é›„ç¨±è™Ÿ" class="w-full bg-slate-50 border-4 border-slate-100 rounded-3xl px-8 py-5 outline-none focus:border-indigo-400 transition font-black text-2xl text-slate-700 shadow-inner text-center">
                
                <div class="space-y-10 bg-indigo-50/50 p-10 rounded-[3rem] border-2 border-indigo-100">
                    <div class="rating-row" data-category="logic">
                        <label class="flex justify-between text-base font-black text-slate-500 uppercase tracking-widest mb-2">åº•å±¤é‚è¼¯ <span class="score-display text-indigo-600 font-black text-3xl">0</span></label>
                        <div class="flex justify-between text-5xl star-row">
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="1"></i>
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="2"></i>
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="3"></i>
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="4"></i>
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="5"></i>
                        </div>
                    </div>
                    <div class="rating-row" data-category="utility">
                        <label class="flex justify-between text-base font-black text-slate-500 uppercase tracking-widest mb-2">è¾¦å…¬å¯¦ç”¨æ€§ <span class="score-display text-emerald-500 font-black text-3xl">0</span></label>
                        <div class="flex justify-between text-5xl star-row">
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="1"></i>
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="2"></i>
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="3"></i>
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="4"></i>
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="5"></i>
                        </div>
                    </div>
                    <div class="rating-row" data-category="innovation">
                        <label class="flex justify-between text-base font-black text-slate-500 uppercase tracking-widest mb-2">æŠ€è¡“å‰µæ–°æ€§ <span class="score-display text-orange-500 font-black text-3xl">0</span></label>
                        <div class="flex justify-between text-5xl star-row">
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="1"></i>
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="2"></i>
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="3"></i>
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="4"></i>
                            <i class="far fa-star cursor-pointer transition-transform hover:scale-110" data-val="5"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-6 mt-12">
                <button onclick="closeRatingModal()" class="flex-1 px-4 py-6 bg-slate-100 rounded-3xl font-black text-slate-400 text-2xl transition hover:bg-slate-200">ç¨å¾Œ</button>
                <button onclick="submitMultiVote()" class="flex-2 px-10 py-6 bg-indigo-600 text-white rounded-3xl font-black shadow-2xl text-2xl transition hover:bg-indigo-700 active:scale-95">å‚³é€èƒ½é‡ âš¡</button>
            </div>
        </div>
    </div>

    <!-- Toast Message -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 px-12 py-6 bg-slate-900 text-white rounded-[2rem] shadow-2xl opacity-0 transition-all duration-500 pointer-events-none z-[110] text-xl font-black tracking-widest uppercase">Action Success</div>

    <script>
        /**
         * ã€æ ¸å¿ƒè¨­å®šã€‘
         * è«‹æ›¿æ›æˆæ‚¨åœ¨ Google Sheet éƒ¨ç½²å¾Œç²å¾—çš„ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ URLã€
         */
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwW-rvZr0lOzoJFfQc_t6ML_Ogx80gKEMZ_6C57iflWFiov5KeSQUwIwHtMlu2AlAd9/exec';

        let currentRatingProjectId = null;
        let selectedScores = { logic: 0, utility: 0, innovation: 0 };
        let isAdminView = false;
        let globalData = [];

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('deadline').value = new Date(Date.now() + 14*86400000).toISOString().split('T')[0];
            
            // æª¢æŸ¥ URL æ˜¯å¦æœ‰è¨­å®š
            if (!GAS_URL || GAS_URL.includes('æ‚¨çš„')) {
                const msg = document.getElementById('statusMessage');
                msg.innerHTML = '<span class="text-red-500 font-black">âš ï¸ ç³»çµ±æœªå°±ç·’ï¼šè«‹æ–¼ç¨‹å¼ç¢¼ä¸­è¨­å®š GAS_URL</span>';
                return;
            }
            
            fetchData();
            setupStars();
        };

        // å¾é›²ç«¯ç²å–è³‡æ–™ (GET)
        async function fetchData() {
            showLoading(true);
            try {
                const response = await fetch(GAS_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                globalData = await response.json();
                updateUI();
            } catch (e) {
                console.error(e);
                showToast("é€£ç·šå¤±æ•—ï¼è«‹ç¢ºèª GAS æ¬Šé™è¨­ç‚ºã€Œæ‰€æœ‰äººã€");
                document.getElementById('statusMessage').textContent = "é€£ç·šç•°å¸¸ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ã€‚";
            }
            showLoading(false);
        }

        // å­˜æª”è‡³é›²ç«¯ (POST)
        async function cloudAction(params) {
            showLoading(true);
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // é‡è¦ï¼šé¿å… CORS é˜»æ“‹ï¼Œè³‡æ–™ä»æœƒé€é”
                    body: JSON.stringify(params)
                });
                // å› ç‚º no-cors ç„¡æ³•è®€å–å›å‚³å€¼ï¼Œæˆ‘å€‘ç¨ç­‰ä¸€ä¸‹å¾Œç›´æ¥åˆ·æ–°
                showToast("åŒæ­¥ä¸­...");
                setTimeout(fetchData, 1500); 
            } catch (e) {
                console.error(e);
                showToast("å­˜æª”å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·š");
                showLoading(false);
            }
        }

        function updateUI() {
            document.getElementById('projectCount').textContent = globalData.length;
            renderProjects(globalData);
            renderSummary(globalData);
        }

        function renderProjects(items) {
            const list = document.getElementById('projectList');
            if (items.length === 0) {
                list.innerHTML = '<div class="text-center py-20 text-slate-400 italic text-2xl bg-white/50 rounded-[3rem] border-2 border-dashed">ç›®å‰å°šç„¡æ¢éšªé»å­ï¼Œå¿«ä¾†ç•¶ç¬¬ä¸€äººï¼</div>';
                return;
            }
            list.innerHTML = [...items].reverse().map(item => {
                const voters = Object.keys(item.votes || {});
                const votesCount = voters.length;
                let scores = { logic: 0, utility: 0, innovation: 0, avg: 0 };
                if (votesCount > 0) {
                    voters.forEach(n => { 
                        scores.logic += Number(item.votes[n].logic); 
                        scores.utility += Number(item.votes[n].utility);
                        scores.innovation += Number(item.votes[n].innovation || 0);
                    });
                    scores.logic = (scores.logic / votesCount).toFixed(1);
                    scores.utility = (scores.utility / votesCount).toFixed(1);
                    scores.innovation = (scores.innovation / votesCount).toFixed(1);
                    scores.avg = ((parseFloat(scores.logic) + parseFloat(scores.utility) + parseFloat(scores.innovation)) / 3).toFixed(1);
                } else { scores.logic = scores.utility = scores.innovation = scores.avg = 'â€”'; }

                return `
                <div class="adventure-card p-12 shadow-xl border-4 border-white transition-all hover:shadow-2xl hover:bg-white group">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-10">
                        <div class="flex-1">
                            <div class="flex flex-wrap items-center gap-4 mb-6">
                                <span class="px-5 py-2 bg-indigo-100 text-indigo-700 rounded-full text-sm font-black uppercase tracking-widest border-2 border-indigo-200">Discovery Mission</span>
                                <span class="text-base text-slate-500 font-bold bg-slate-50 px-5 py-2 rounded-full border border-slate-200">
                                    <i class="far fa-compass mr-3 text-indigo-500"></i>${formatDate(item.startDate)} â” <span class="text-orange-600 font-black">æŠµé”æ—¥: ${formatDate(item.deadline)}</span>
                                </span>
                            </div>
                            <h3 class="text-5xl font-black text-slate-800 leading-tight group-hover:text-indigo-600 transition-colors mb-6">${item.topic}</h3>
                            <div class="flex flex-wrap items-center gap-8">
                                <span class="text-indigo-600 font-black text-2xl italic flex items-center">
                                    <div class="w-14 h-14 rounded-full bg-indigo-100 flex items-center justify-center mr-4 text-xl border-2 border-white shadow-sm"><i class="fas fa-user-ninja"></i></div>
                                    @${item.name}
                                </span>
                                <div class="flex items-center gap-8 bg-slate-50/80 backdrop-blur-sm px-8 py-4 rounded-[2rem] border-2 border-white shadow-inner">
                                    <div class="flex items-center text-amber-500 text-2xl font-black"><i class="fas fa-bolt mr-3 text-yellow-500 text-3xl"></i>æˆå°± ${scores.avg}</div>
                                    <div class="w-0.5 h-8 bg-slate-200"></div>
                                    <div class="text-sm text-slate-400 font-black tracking-widest uppercase">L:${scores.logic} | U:${scores.utility} | I:${scores.innovation}</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-5 w-full md:w-auto">
                            <span class="px-8 py-4 rounded-3xl text-sm font-black uppercase tracking-widest shadow-lg border-b-8 transition-all ${getStatusClass(item.status)}">${item.status}</span>
                            <div class="flex gap-3">
                                <button onclick="toggleStatus('${item.id}')" title="åˆ‡æ›ç‹€æ…‹" class="p-5 bg-white text-slate-400 hover:text-indigo-600 rounded-[1.5rem] transition shadow-md border-2 border-slate-100 hover:shadow-xl"><i class="fas fa-sync-alt text-2xl"></i></button>
                                ${item.status === 'âœ¨ åœ“æ»¿é”æˆç›®æ¨™' ? `<button onclick="openRatingModal('${item.id}', '${item.topic}')" class="bg-indigo-600 text-white px-12 py-5 rounded-[1.5rem] font-black text-sm tracking-[0.4em] shadow-xl hover:bg-indigo-700 hover:-translate-y-1 transition active:scale-95">å¥§æ´</button>` : ''}
                                <button onclick="deleteProject('${item.id}')" class="p-5 text-slate-100 hover:text-red-500 transition"><i class="far fa-trash-alt text-2xl"></i></button>
                            </div>
                        </div>
                    </div>
                    ${isAdminView && votesCount > 0 ? `<div class="admin-only mt-12 pt-12 border-t-4 border-dashed border-slate-100">
                        <p class="text-sm font-black text-slate-400 uppercase tracking-[0.3em] mb-6">å¥§æ´æˆ°æ­·</p>
                        <div class="flex flex-wrap gap-4">
                            ${voters.map(v => `<div class="bg-white px-6 py-4 rounded-3xl border-2 border-slate-100 shadow-sm text-base font-black">
                                <span class="text-indigo-600 text-xl mr-2">${v}</span>: L:${item.votes[v].logic} U:${item.votes[v].utility} I:${item.votes[v].innovation}
                            </div>`).join('')}
                        </div>
                    </div>` : ''}
                </div>`;
            }).join('');
            applyAdminVisibility();
        }

        function renderSummary(items) {
            const stats = {};
            items.forEach(item => {
                if (!stats[item.name]) stats[item.name] = { total: 0, logic: 0, utility: 0, innovation: 0, voteCount: 0 };
                stats[item.name].total++;
                const votes = Object.values(item.votes || {});
                if (votes.length > 0) {
                    votes.forEach(v => { 
                        stats[item.name].logic += Number(v.logic); 
                        stats[item.name].utility += Number(v.utility); 
                        stats[item.name].innovation += Number(v.innovation || 0); 
                        stats[item.name].voteCount++; 
                    });
                }
            });
            const sorted = Object.keys(stats).sort((a,b) => {
                const scoreB = (stats[b].logic + stats[b].utility + stats[b].innovation) / (stats[b].voteCount * 3 || 1);
                const scoreA = (stats[a].logic + stats[a].utility + stats[a].innovation) / (stats[a].voteCount * 3 || 1);
                return scoreB - scoreA;
            });

            document.getElementById('summaryTableBody').innerHTML = sorted.map((name, index) => {
                const s = stats[name];
                const avgL = s.voteCount > 0 ? (s.logic / s.voteCount).toFixed(1) : '0.0';
                const avgU = s.voteCount > 0 ? (s.utility / s.voteCount).toFixed(1) : '0.0';
                const avgI = s.voteCount > 0 ? (s.innovation / s.voteCount).toFixed(1) : '0.0';
                const totalAvg = ((parseFloat(avgL) + parseFloat(avgU) + parseFloat(avgI)) / 3).toFixed(1);
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ‘¤';

                return `
                <tr class="border-t-2 border-slate-100 hover:bg-indigo-50/50 transition group">
                    <td class="px-10 py-10 font-black text-slate-800 text-3xl italic">
                        <span class="mr-6 inline-block transform group-hover:scale-125 transition-transform">${medal}</span>@${name}
                    </td>
                    <td class="px-6 py-10 text-center text-slate-400 text-3xl font-mono">${s.total}</td>
                    <td class="px-6 py-10 text-center text-slate-400 font-black text-3xl font-mono">${s.voteCount}</td>
                    <td class="px-6 py-10 text-center font-bold text-slate-400 italic text-2xl">${avgL}</td>
                    <td class="px-6 py-10 text-center font-bold text-slate-400 italic text-2xl">${avgU}</td>
                    <td class="px-6 py-10 text-center font-bold text-orange-400 italic text-2xl">${avgI}</td>
                    <td class="px-10 py-10 text-right">
                        <span class="bg-indigo-600 text-white px-10 py-4 rounded-3xl font-black shadow-xl ring-8 ring-indigo-50 text-4xl font-mono">${totalAvg}</span>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- Core Functions ---
        document.getElementById('aiForm').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const topic = document.getElementById('topic').value.trim();
            if (!name || !topic) return;

            const newProject = {
                action: 'create',
                id: Date.now(),
                name: name,
                topic: topic,
                startDate: document.getElementById('startDate').value,
                deadline: document.getElementById('deadline').value,
                status: 'ğŸš€ æ­£åœ¨èµ·é£›'
            };
            await cloudAction(newProject);
            e.target.reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('deadline').value = new Date(Date.now() + 14*86400000).toISOString().split('T')[0];
            showToast("é»å­å·²å‚³é€è‡³é›²ç«¯ï¼ğŸŒŸ");
        };

        async function toggleStatus(id) {
            const item = globalData.find(p => p.id.toString() === id.toString());
            if (!item) return;
            const states = ['ğŸš€ æ­£åœ¨èµ·é£›', 'ğŸ” å¯¦é©—å®¤èª¿æ ¡ä¸­', 'âœ¨ åœ“æ»¿é”æˆç›®æ¨™'];
            const newStatus = states[(states.indexOf(item.status) + 1) % 3];
            await cloudAction({ action: 'updateStatus', id: id, status: newStatus });
        }

        async function submitMultiVote() {
            const voter = document.getElementById('voterName').value.trim();
            if (!voter || Object.values(selectedScores).some(v => v === 0)) {
                showToast("æ¯å€‹èƒ½é‡ç¶­åº¦éƒ½å¿…é ˆå¡«æ»¿å–”ï¼");
                return;
            }
            const item = globalData.find(p => p.id.toString() === currentRatingProjectId.toString());
            if (item.name === voter) {
                showToast("ä¸èƒ½å¥§æ´è‡ªå·±å•¦ï¼è¦è¬™è™›å–” ğŸ˜Š");
                return;
            }
            
            const newVotes = { ...(item.votes || {}) };
            newVotes[voter] = { ...selectedScores, time: new Date().toLocaleString() };
            
            await cloudAction({ action: 'updateVote', id: currentRatingProjectId, votes: newVotes });
            closeRatingModal();
            showToast("å¥§æ´èƒ½é‡ç™¼é€å®Œç•¢ï¼âš¡");
        }

        async function deleteProject(id) {
            if (confirm("é€™æœƒå¾é›²ç«¯æ°¸ä¹…åˆªé™¤é€™å€‹é»å­ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                await cloudAction({ action: 'delete', id: id });
            }
        }

        // --- UI Utils ---
        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
        function showToast(m) { 
            const t = document.getElementById('toast'); 
            t.textContent = m; 
            t.style.opacity = '1'; 
            t.style.transform = 'translate(-50%, -20px)';
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translate(-50%, 0)';
            }, 3000); 
        }
        function toggleAdminView() { 
            isAdminView = !isAdminView; 
            const btn = document.getElementById('adminBtn');
            btn.classList.toggle('text-indigo-600', isAdminView);
            btn.classList.toggle('border-indigo-600', isAdminView);
            updateUI(); 
        }
        function applyAdminVisibility() { document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdminView ? 'block' : 'none'); }
        function getStatusClass(s) { 
            if (s === 'âœ¨ åœ“æ»¿é”æˆç›®æ¨™') return 'bg-emerald-500 text-white border-emerald-600 shadow-emerald-100';
            if (s === 'ğŸ” å¯¦é©—å®¤èª¿æ ¡ä¸­') return 'bg-amber-400 text-white border-amber-500 shadow-amber-100';
            return 'bg-indigo-600 text-white border-indigo-700 shadow-indigo-100';
        }
        function formatDate(d) {
            if (!d) return '';
            const date = new Date(d);
            return isNaN(date.getTime()) ? d : `${date.getMonth()+1}/${date.getDate()}`;
        }
        function openRatingModal(id, title) {
            currentRatingProjectId = id; selectedScores = { logic: 0, utility: 0, innovation: 0 };
            document.getElementById('ratingProjectName').textContent = title;
            document.querySelectorAll('.score-display').forEach(d => d.textContent = '0');
            document.querySelectorAll('.star-row i').forEach(s => { s.classList.replace('fas','far'); s.classList.remove('star-rating-active'); });
            document.getElementById('ratingModal').classList.remove('hidden');
        }
        function closeRatingModal() { document.getElementById('ratingModal').classList.add('hidden'); }
        function setupStars() {
            document.querySelectorAll('.rating-row').forEach(row => {
                const cat = row.dataset.category;
                const stars = row.querySelectorAll('.star-row i');
                stars.forEach(s => {
                    s.onmouseover = () => highlightStars(row, s.dataset.val);
                    s.onclick = () => { selectedScores[cat] = parseInt(s.dataset.val); row.querySelector('.score-display').textContent = selectedScores[cat]; highlightStars(row, selectedScores[cat]); };
                });
                row.onmouseleave = () => highlightStars(row, selectedScores[cat]);
            });
        }
        function highlightStars(row, val) {
            row.querySelectorAll('.star-row i').forEach(s => {
                if (s.dataset.val <= val) { s.classList.replace('far', 'fas'); s.classList.add('star-rating-active'); }
                else { s.classList.replace('fas', 'far'); s.classList.remove('star-rating-active'); }
            });
        }
    </script>
</body>
</html>
