function doGet() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const data = sheet.getDataRange().getValues();
  if (data.length < 2) return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
  const headers = data.shift();
  const json = data.map(row => {
    let obj = {};
    headers.forEach((header, i) => {
      let head = header.toString().trim().toLowerCase();
      if (head === 'votes' && row[i]) {
        try { obj['votes'] = JSON.parse(row[i]); } catch(e) { obj['votes'] = {}; }
      } else {
        obj[head] = row[i];
      }
    });
    return obj;
  });
  return ContentService.createTextOutput(JSON.stringify(json)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const params = JSON.parse(e.postData.contents);
  const action = params.action;
  const data = sheet.getDataRange().getValues();
  const headers = data[0].map(h => h.toString().trim().toLowerCase());

  if (action === 'create') {
    sheet.appendRow([params.id, params.name, params.topic, params.startDate, params.deadline, params.status, JSON.stringify({})]);
  } else if (action === 'updateStatus' || action === 'updateVote') {
    const targetId = params.id.toString();
    const colName = action === 'updateStatus' ? 'status' : 'votes';
    const colIndex = headers.indexOf(colName);
    const newValue = action === 'updateStatus' ? params.status : JSON.stringify(params.votes);
    if (colIndex > -1) {
      for (let i = 1; i < data.length; i++) {
        if (data[i][0].toString() === targetId) {
          sheet.getRange(i + 1, colIndex + 1).setValue(newValue);
          break;
        }
      }
    }
  } else if (action === 'delete') {
    const targetId = params.id.toString();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0].toString() === targetId) {
        sheet.deleteRow(i + 1);
        break;
      }
    }
  }
  return ContentService.createTextOutput("Success").setMimeType(ContentService.MimeType.TEXT);
}
